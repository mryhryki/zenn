---
title: "AWS API Gateway ã® WebSocket ã®ä»•çµ„ã¿ã‚’ç†è§£ã™ã‚‹"
emoji: "ðŸ‘‹"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["AWS", "API Gateway", "WebSocket"]
published: false
---

## ã¯ã˜ã‚ã«

ã“ã‚Œã¯ AWS ã®ã‚µãƒ¼ãƒ“ã‚¹ã®ä¸€ã¤ã€[API Gateway](https://aws.amazon.com/jp/api-gateway/) ã® [WebSocket](https://docs.aws.amazon.com/ja_jp/apigateway/latest/developerguide/apigateway-websocket-api-overview.html) ã‚’ç†è§£ã™ã‚‹ãŸã‚ã«æ›¸ã„ãŸè¨˜äº‹ã§ã™ã€‚
[ç™ºè¡¨å½“åˆ](https://aws.amazon.com/jp/blogs/news/announcing-websocket-apis-in-amazon-api-gateway/)ã‹ã‚‰å€‹äººçš„ã«ä½¿ã£ã¦ã„ã‚‹ã®ã§ã™ãŒã€çµå±€ API Gateway ã® WebSocket ã¯ä½•ã‚’æä¾›ã—ã¦ãã‚Œã¦ã€ä½•ã‚’å®Ÿè£…ã—ãªã„ã¨ã„ã‘ãªã„ã®ã‹ã‚’ã¾ã¨ã‚ãŸã„ãªã€ã¨æ€ã£ãŸã®ã§æ›¸ãã¾ã—ãŸã€‚



## ã¾ã¨ã‚

ã¾ãš API Gateway ãŒç®¡ç†ã—ã¦ãã‚Œã‚‹ã‚‚ã®ã¨è‡ªåˆ†ã§å®Ÿè£…ã—ãªã„ã¨ã„ã‘ãªã„ã‚‚ã®ã‚’ã¾ã¨ã‚ã¦ãŠãã¾ã™ã€‚

### API Gateway ãŒç®¡ç†ã—ã¦ãã‚Œã‚‹ã‚‚ã®

- WebSocket ã®ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³
- WebSocket ã®ã‚¤ãƒ™ãƒ³ãƒˆ/ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡æ™‚ã«ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼ˆLambda ãªã©ï¼‰è»¢é€

### è‡ªåˆ†ã§å®Ÿè£…ã—ãªã„ã¨ã„ã‘ãªã„ã‚‚ã®

- ã‚¤ãƒ™ãƒ³ãƒˆé€ä¿¡
- ã‚¤ãƒ™ãƒ³ãƒˆ/ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡æ™‚ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼ˆLambda ãªã©ï¼‰
- æŽ¥ç¶šã®ä¸€è¦§ç®¡ç†ï¼ˆå¿…è¦ã§ã‚ã‚Œã°ï¼‰



## ã‚µãƒ³ãƒ—ãƒ«å®Ÿè£…ã®ç´¹ä»‹

ä»Šå›žã¯ã‚µãƒ³ãƒ—ãƒ«å®Ÿè£…ã§æŒ™å‹•ã‚’ç¢ºèªã—ã¦ã„ã¾ã™ã€‚
ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯ GitHub ã«ç½®ã„ã¦ã„ã‚‹ã®ã§ã€ã‚‚ã—å‚ç…§ã—ãŸã„æ–¹ã¯ã“ã¡ã‚‰ã‚’ã”è¦§ãã ã•ã„ã€‚
[hyiromori/example-aws-api-gateway-websocket](https://github.com/hyiromori/example-aws-api-gateway-websocket)

å‹•ãã‚³ãƒ¼ãƒ‰ã¯æ•°åè¡Œã—ã‹ãªã„ã€ã”ãå°ã•ãªãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã™ã€‚



## å„ã‚¤ãƒ™ãƒ³ãƒˆã§ã®æŒ™å‹•

### æŽ¥ç¶šæ™‚


### ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡æ™‚



### åˆ‡æ–­æ™‚



## WebSocket ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚é–“

å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æŽ¢ã—ã¦ã„ãŸã®ã§ã™ãŒã€è¦‹ã¤ã‘ãã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚
ãã‚‚ãã‚‚ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®è¨­å®šã«ã‚ˆã‚‹ã‚‚ã®ã¨ã‹ã‚‚ã‚ã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã®ã§ã€å®šç¾©ã§ããªã„ã¨ã‹ã‚‚ã‚ã‚‹ã®ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
ï¼ˆç§ã‚‚ WebSocket ã«ã‚ã¾ã‚Šè©³ã—ããªã„ã®ã§ã€ã‚‚ã—ã“ã®è¾ºã‚Šã”å­˜ã˜ã®æ–¹ãŒã„ã‚Œã°æ•™ãˆã¦ã„ãŸã ããŸã„ã§ã™ï¼‰

ã¨ã„ã†ã“ã¨ã§ã€å®Ÿéš›ã« API Gateway ã¨ Chrome ã®é–‹ç™ºè€…ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§è©¦ã—ã¦ã¿ãŸçµæžœã‚’ Scrapbox ã«ã¾ã¨ã‚ã¦ã¿ã¾ã—ãŸã€‚

### ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã®èª¿æŸ»

WebSocket ã¯ `readyState` ã§ç¾åœ¨ã®çŠ¶æ…‹ãŒå…¥ã£ã¦ã„ã‚‹ã®ã§ã€ã“ã‚Œã§ç¢ºèªã§ãã‚‹ã€‚
ä¸»ã« `1` ãŒæŽ¥ç¶šçŠ¶æ…‹ `3` ãŒåˆ‡æ–­æ¸ˆã¿ã®çŠ¶æ…‹ãŒã‚ã‹ã£ã¦ã„ã‚Œã°å¤§ä¸ˆå¤«ã€‚
https://developer.mozilla.org/ja/docs/Web/API/WebSocket/readyState

Chrome DevTools ã§è©¦ã—ã¦ã¿ã¾ã—ãŸã€‚
[https://gyazo.com/9eb4cda512f58a8cb6a9b407f9a52b56]

Chrome DevTools ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰å®Ÿé¨“ã—ã¦ã¿ãŸçµæžœã€‚

```text
> let ws = new WebSocket('wss://u3ka4x96a7.execute-api.us-east-1.amazonaws.com/prod')
> (new Date()).toISOString().substr(11, 8)
08:12:53
> setInterval(() => console.log((new Date()).toISOString().substr(11, 8), ws.readyState), 1000)
(çœç•¥)
08:14:53 1
08:14:54 3
```

æŽ¥ç¶šå¾Œã€ï¼‘åˆ†é–“ä½•ã‚‚ã—ãªã„ã¨ã€ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ãŒåˆ‡æ–­ã•ã‚Œã‚‹ã¿ãŸã„ã€‚
ãŸã ã€ä¸€åº¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹ã¨ï¼’åˆ†ã«å»¶é•·ã•ã‚Œã‚‹ã‚ˆã†ã§ã™ã€‚

```bash
> let ws = new WebSocket('wss://xxxxxxxxxx.execute-api.us-east-1.amazonaws.com/prod')
> ws.send('MESSAGE')
> (new Date()).toISOString().substr(11, 8)
08:23:00
> setInterval(() => console.log((new Date()).toISOString().substr(11, 8), ws.readyState), 1000)
(çœç•¥)
08:25:00 1
08:25:01 3
```

### ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã‚’åˆ‡æ–­ã•ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹ã«ã¯ï¼Ÿ

ï¼ˆâ€»ä»Šå›žã®å®Ÿé¨“ã®çµæžœã§ã‚ã‚Šã€å…¨ã¦ã®ç’°å¢ƒã§åŒã˜ã«ãªã‚‹ã‹ã¯ä¸æ˜Žã§ã™ã€‚å®Ÿéš›ã«ä½¿ç”¨ã™ã‚‹å ´åˆã¯ã€å®Ÿè¡Œã™ã‚‹ç’°å¢ƒã§å¿…ãšãƒ†ã‚¹ãƒˆã—ã¦ãã ã•ã„ï¼‰

ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ç¢ºç«‹å¾Œã«ä¸€åº¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¦ã€ãã®å¾Œã¯2åˆ†æœªæº€ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã§é©å½“ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã£ã¦ãŠãã¨ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ãŒç¶­æŒã§ããã†ãªæ°—ãŒã—ã¾ã—ãŸã€‚
è©¦ã—ã«ä»¥ä¸‹ã®ã‚ˆã†ã«ï¼‘åˆ†ã”ã¨ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚Šç¶šã‘ã‚‹ã¨ã€15åˆ†ä»¥ä¸Šã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ãŒç¶­æŒã§ãã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã—ãŸã€‚

```javascript
setInterval(() => ws.send('ping'), 60000)
```
