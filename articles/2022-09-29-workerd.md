---
title: "Cloudflare ã® JavaScript ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã€Œworkerdã€ã‚’å‹•ã‹ã—ã¦ã¿ã‚‹"
emoji: "ğŸƒğŸ»"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["JavaScript","Cloudflare"]
published: true
---

# ã¯ã˜ã‚ã«

Publickey ã§ä»¥ä¸‹ã®è¨˜äº‹ã‚’è¦‹ã¤ã‘ã¦ã€ã©ã‚“ãªã‚‚ã®ã‹å‹•ã‹ã—ã¦ã¿ãŸè¨˜éŒ²ã§ã™ã€‚

https://www.publickey1.jp/blog/22/cloudflare_workersjavascriptwasmworkerdnanoserviceshomogeneous_deployment.html

è©³ã—ã„è§£èª¬ã¯ä¸Šè¨˜ã®è¨˜äº‹ã‚’è¦‹ã¦ã‚‚ã‚‰ãˆã‚Œã°ã¨æ€ã„ã¾ã™ãŒã€ç§ãŒç‰¹ã«é­…åŠ›ã‚’æ„Ÿã˜ãŸã®ã¯ä»¥ä¸‹ã®ç‚¹ã§ã—ãŸã€‚

> æ¨™æº–æº–æ‹ ã§ãƒ­ãƒƒã‚¯ã‚¤ãƒ³ã¯ã•ã‚Œãªã„
> 
> workerdã¯ã‚µãƒ¼ãƒå‘ã‘ã®JavaScript/WebAssemblyã®ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã§ã™ãŒã€åŸºæœ¬çš„ã«ã¯Webãƒ–ãƒ©ã‚¦ã‚¶ãŒå‚™ãˆã¦ã„ã‚‹APIã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚
> 
> ã¨åŒæ™‚ã«Denoã‚„Node.jsãªã©ã¨å…±ã«ä»Šå¹´ç«‹ã¡ä¸Šã’ãŸéWebãƒ–ãƒ©ã‚¦ã‚¶ç³»JavaScriptãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã®ã‚³ãƒ¼ãƒ‰äº’æ›ã‚’å®Ÿç¾ã™ã‚‹ãƒ¯ãƒ¼ã‚¯ã‚°ãƒ«ãƒ¼ãƒ—ã®æ¨™æº–ã«å¾“ã†ã¨ã—ã¦ãŠã‚Šã€ã‚³ãƒ¼ãƒ‰ã®workerdã¸ã®ãƒ­ãƒƒã‚¯ã‚¤ãƒ³ã¯èµ·ã“ã‚‰ãªã„ã¨ã—ã¦ã„ã¾ã™ã€‚


## ãŠã“ã¨ã‚ã‚Š

[workerd](https://github.com/cloudflare/workerd) ã¯ç¾æ™‚ç‚¹ã§ Beta ç‰ˆã§ã™ã€‚
æ©Ÿèƒ½ãŒä¸è¶³ã—ã¦ã„ãŸã‚Šã€ç ´å£Šçš„å¤‰æ›´ãŒè¡Œã‚ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã®ã§ã€ã”æ³¨æ„ãã ã•ã„ã€‚

![workerd is Beta](https://mryhryki.com/file/UVgBp1i_ULFY9gWQ6IB5Tl1d8o8aIKK2Zg8g4bNTZ0ebwgAk.png)

[WARNING: This is a beta. Work in progress.](https://github.com/cloudflare/workerd/blob/a2376c452624b5a68b467465d17b81314ebf9452/README.md#warning-this-is-a-beta-work-in-progress)

ã“ã®è¨˜äº‹ã®å‹•ä½œç¢ºèªã§ã¯ã€ã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥ [a2376c4](https://github.com/cloudflare/workerd/commit/a2376c452624b5a68b467465d17b81314ebf9452) ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚


# workerd ã‚’å‹•ã‹ã™

[README ã® Getting Started](https://github.com/cloudflare/workerd/blob/a2376c452624b5a68b467465d17b81314ebf9452/README.md#getting-started) ã«å¾“ã£ã¦ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¦ã„ã¾ã™ã€‚

## 1. ãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³

ã¾ãšã¯ãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ã—ã¾ã™ã€‚

```shell
$ git clone git@github.com:cloudflare/workerd.git
$ cd ./workerd/
```

## 2. Bazel (Bazelisk) ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

ãƒ“ãƒ«ãƒ‰ã«ã¯ Bazel ã¨ã„ã†ãƒ„ãƒ¼ãƒ«ãŒå¿…è¦ã«ãªã‚‹ã‚ˆã†ã§ã™ã€‚
README ã®ãƒªãƒ³ã‚¯ã‚’é–‹ãã¨ [Bazelisk](https://bazel.build/install/bazelisk) ã¨ã„ã†ãƒ„ãƒ¼ãƒ«ã‚’ãŠã™ã™ã‚ã•ã‚Œã¦ã„ãŸã®ã§ã€ãã¡ã‚‰ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

macOS ã‚’ä½¿ã£ã¦ã„ã‚‹ã®ã§ [Homebrew](https://brew.sh/) ã§ç°¡å˜ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã¾ã—ãŸã€‚

```shell
$ brew install bazelisk
```

## 3. Xcode ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª

README ã‚’è¦‹ã‚‹ã¨ã€macOS ã®å ´åˆã¯ `Xcode 13` ä»¥é™ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚‹ã‚ˆã†ã§ã™ã€‚
ç§ã®å ´åˆã¯ `14.0.1` ãŒå…¥ã£ã¦ã„ãŸã®ã§ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã ã‘ç¢ºèªã—ã¦çµ‚ã‚ã‚Šã¾ã—ãŸã€‚

## 4. workerd ã®ãƒ“ãƒ«ãƒ‰

`bazelisk` ã‚’ä½¿ã£ã¦ `workerd` ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¾ã™ã€‚

```shell
$ bazelisk build -c opt //src/workerd/server:workerd

...

INFO: Elapsed time: 2512.784s, Critical Path: 53.88s
INFO: 8341 processes: 3309 internal, 5031 darwin-sandbox, 1 local.
INFO: Build completed successfully, 8341 total actions
```

å¤§ä½“42åˆ†ãã‚‰ã„ã‹ã‹ã£ã¦ã„ã¾ã™ã€‚é•·ã„ã€‚

### è£œè¶³

README ã§ã¯ `bazel` ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã†ã‚ˆã†ã«æ›¸ã‹ã‚Œã¦ã„ã¾ã™ãŒã€ä»Šå›ã¯ `bazelisk` ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸã®ã§ã€ã‚³ãƒãƒ³ãƒ‰ã‚’ç½®ãæ›ãˆã¦ã„ã¾ã™ã€‚

```diff
- $ bazel build ...
+ $ bazelisk build ...
```

## 5. ãƒ‘ã‚¹ã‚’é€šã™

ãƒ“ãƒ«ãƒ‰ã—ãŸ `workerd` ã®ãƒã‚¤ãƒŠãƒªã¯ `(Repository root)/bazel-bin/src/workerd/server/workerd` ã«å‡ºåŠ›ã•ã‚Œã¦ã„ã¾ã™ã€‚
ã“ã®ãƒã‚¤ãƒŠãƒªã‚’ãƒ‘ã‚¹ã®é€šã£ãŸã¨ã“ã‚ã«ç§»å‹• (or ã‚³ãƒ”ãƒ¼) ã™ã‚Œã°OKã§ã™ã€‚

ï¼ˆãŒã€ä»Šå›ã¯ä¸€æ™‚çš„ã«è©¦ã—ã¦ã¿ãŸã‹ã£ãŸã®ã§ã€ä¸€æ—¦ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒ‘ã‚¹ã‚’é€šã—ã¾ã—ãŸï¼‰

```shell
$ export PATH="$(pwd)/bazel-bin/src/workerd/server/:${PATH}"
```

## 6. å‹•ä½œç¢ºèª

ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç¢ºèªã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã§ã€å‹•ä½œã™ã‚‹ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚

```shell
$ workerd --version
workerd 2022-09-26
```

ä»¥ä¸Šã§ã€æº–å‚™ã¯å®Œäº†ã§ã™ã€‚

# å‹•ã‹ã—ã¦ã¿ã‚‹

ãƒªãƒã‚¸ãƒˆãƒªã® `/samples` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚µãƒ³ãƒ—ãƒ«ãŒ4ã¤ç”¨æ„ã•ã‚Œã¦ã„ãŸã®ã§å‹•ã‹ã—ã¦ã¿ã¾ã™ã€‚

## Hello world

`helloworld` ã¨ `helloworld_esm` ã®ï¼’ç¨®é¡ãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ãŒã€æ›¸ãæ–¹ã®é•ã„ã ã‘ã§å‹•ä½œçš„ã«ã¯åŒã˜ã§ã—ãŸã€‚
ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§å®Ÿè¡Œã§ãã¾ã™ã€‚

```shell
$ workerd serve ./samples/helloworld/config.capnp
# or
$ workerd serve ./samples/helloworld_esm/config.capnp
```

http://localhost:8080/ ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨å‹•ä½œç¢ºèªã§ãã¾ã™ã€‚

```shell
$ curl http://localhost:8080/
Hello World
```

## é™çš„ãƒ•ã‚¡ã‚¤ãƒ«é…ä¿¡

`static-files-from-disk` ã¨ã„ã†ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯é™çš„ãªãƒ•ã‚¡ã‚¤ãƒ«é…ä¿¡ã®ã‚µãƒ³ãƒ—ãƒ«ã®ã‚ˆã†ã§ã™ã€‚
ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§å®Ÿè¡Œã§ãã¾ã™ã€‚

```shell
$ cd samples/static-files-from-disk/
$ workerd serve ./config.capnp
```

http://localhost:8080/ ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨å‹•ä½œç¢ºèªã§ãã¾ã™ã€‚

![Result](https://mryhryki.com/file/UVfhxaFu6o7mKr8mVwsymFfF-C4-6gdpxkImj3INcYk697SY.png)

ã¡ãªã¿ã« `--directory-path site-files="(ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ‘ã‚¹)"` ã‚’æŒ‡å®šã™ã‚‹ã¨é…ä¿¡ã—ãŸã„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å¤‰æ›´ã§ãã‚‹ã‚ˆã†ã§ã™ã€‚

```shell
$ workerd serve samples/static-files-from-disk/config.capnp --directory-path site-files="$(pwd)/samples/static-files-from-disk/content-dir/"
```

([è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚³ãƒ¡ãƒ³ãƒˆ](https://github.com/cloudflare/workerd/blob/46119264c20bc3da7db2ce5cefa983e5d564c7b6/samples/static-files-from-disk/config.capnp#L3-L6) ã«æ›¸ã„ã¦ã‚ã‚Šã¾ã—ãŸ)

## ãƒãƒ£ãƒƒãƒˆ

`durable-objects-chat` ã¨ã„ã†ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯ã€ãƒãƒ£ãƒƒãƒˆãŒã§ãã‚‹ã‚µãƒ³ãƒ—ãƒ«ã®ã‚ˆã†ã§ã™ã€‚
ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§å®Ÿè¡Œã§ãã¾ã™ã€‚

```shell
$ workerd serve ./samples/durable-objects-chat/config.capnp
```

http://localhost:8080/ ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨å‹•ä½œç¢ºèªã§ãã¾ã™ã€‚

![Chat capture](https://mryhryki.com/file/UVfLHzf68e8B8oujs0VACdWxdSeQ6zhEB9DvTyIZ5pr1Gkdc.png)

ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªåã«å…¥ã£ã¦ã„ã‚‹ã‚ˆã†ã« [Durable Objects](https://blog.cloudflare.com/ja-jp/durable-objects-ga-ja-jp/) ã¨ã„ã†æ©Ÿèƒ½ã‚’ä½¿ã£ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚
åˆã‚ã¦èã„ãŸã®ã§ã‚ˆãåˆ†ã‹ã£ã¦ã„ã¾ã›ã‚“ãŒã€çŠ¶æ…‹ã‚’æ°¸ç¶šåŒ–ã—ã¦ãŠãæ©Ÿèƒ½ã®ã‚ˆã†ã§ã™ã€‚

> Durable Objects are currently supported only in a mode that uses in-memory storage

README ã«æ›¸ã‹ã‚Œã¦ã„ã¾ã—ãŸãŒã€ç¾æ™‚ç‚¹ã§ã¯ãƒ¡ãƒ¢ãƒªã«ä¿å­˜ã™ã‚‹ã®ã§æ°¸ç¶šåŒ–ã™ã‚‹äº‹ã¯ã§ããªã„ã‚ˆã†ã§ã™ã€‚

# ãã®ä»–ã®ãƒ¡ãƒ¢

## hello world ã®ä¸­èº«

`addEventListener('fetch', ...)` ã¨æ›¸ã‹ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«ã€(`fetch`) ã‚¤ãƒ™ãƒ³ãƒˆã«å¯¾ã—ã¦ãƒãƒ³ãƒ‰ãƒ©ã‚’ç™»éŒ²ã™ã‚‹ã¨ã„ã†å½¢ã§å®Ÿè£…ã™ã‚‹ã‚ˆã†ã§ã™ã€‚
Service Worker ã®æ›¸ãæ–¹ã¨åŒã˜æ„Ÿã˜ãªã®ã§ã€é¦´æŸ“ã¿ã‚„ã™ã„ã§ã™ã­ã€‚

```javascript
// samples/helloworld/worker.js
addEventListener('fetch', event => {
  event.respondWith(handle(event.request));
});

async function handle(request) {
  return new Response("Hello World\n");
}
```

ã¾ãŸ esm ã®æ–¹ã ã¨ `fetch` ã‚’å«ã‚€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ `export default` ã—ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚

```javascript
export default {
  async fetch(req, env) {
    return new Response("Hello World\n");
  }
};
```

## workerd ã®ã‚³ãƒãƒ³ãƒ‰

`workerd --help` ã‚’è¦‹ã¦ã¿ã‚‹ã¨ã€`compile` ã¨ `serve` ã®ï¼’ç¨®é¡ã®ã‚³ãƒãƒ³ãƒ‰ã®ã¿ãŒç”¨æ„ã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚

```shell
$ workerd --help
Usage: workerd [<option>...] <command> [<arg>...]

Runs the Workers JavaScript/Wasm runtime.

Commands:
  compile  create a self-contained binary
  serve    run the server

See 'workerd help <command>' for more information on a specific command.

Options:
    --verbose
        Log informational messages to stderr; useful for debugging.
    --version
        Print version information and exit.
    --help
        Display this help text and exit.
```

ãã‚Œãã‚Œã®ã‚³ãƒãƒ³ãƒ‰ã®èª¬æ˜ã‚‚è¦‹ã¦ã¿ã¾ã™ã€‚

```shell
$ workerd help serve
Usage: workerd serve [<option>...] <config-file> [<const-name>]

Serve requests based on a config.

...

$ workerd help compile
Usage: workerd compile [<option>...] <config-file> [<const-name>]

Builds a self-contained binary from a config.

...
```

`serve` ã®æ–¹ã¯ã€ã“ã‚Œã¾ã§å‹•ä½œç¢ºèªã‚’ã—ã¦ããŸã‚ˆã†ã«ã‚µãƒ¼ãƒãƒ¼ã‚’ç«‹ã¡ä¸Šã’ã‚‹ãŸã‚ã«ä½¿ã†ã‚ˆã†ã§ã™ã€‚

`compile` ã®æ–¹ã¯ã€ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚’å«ã‚€ãƒã‚¤ãƒŠãƒªã¨ã—ã¦å‡ºåŠ›ã—ã¦ãã‚Œã‚‹ã‚‚ã®ã®ã‚ˆã†ã§ã™ã€‚
å®Ÿéš›ã« Hello world ã®ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã§ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ã¦ã¿ã¾ã—ãŸã€‚

```shell
$ workerd compile samples/helloworld/config.capnp > helloworld
$ ./helloworld 
```

http://localhost:8080/ ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã£ã¦ãã¾ã—ãŸã€‚

```shell
$ curl http://localhost:8080/
Hello World
```

å®¹é‡çš„ã«ã‚‚ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ãŒå«ã¾ã‚Œã¦ã„ãã†ã§ã™ã­ã€‚

```shell
$ wc -c ./helloworld 
 81258168 ./helloworld
 
$ wc -c ./bazel-bin/src/workerd/server/workerd
 81257684 ./bazel-bin/src/workerd/server/workerd
```

[deno compile](https://deno.land/manual@v1.26.0/tools/compiler) ã«ä¼¼ã¦ã„ã‚‹ãªã€ã¨æ€ã„ã¾ã—ãŸã€‚

# ãŠã‚ã‚Šã«

ã¾ãŸèª°ã§ã‚‚ä½¿ãˆã‚‹ JavaScript ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ãŒå¢—ãˆã¦ã€ç››ã‚Šä¸ŠãŒã£ã¦ãã¦ã„ã‚‹æ„Ÿã˜ãŒã—ã¦éå¸¸ã«å¬‰ã—ã„ã§ã™ã­ã€‚
ç‰¹ã«æ¨™æº–APIã‚’ãƒ™ãƒ¼ã‚¹ã«ã—ã¦ã€ãƒ­ãƒƒã‚¯ã‚¤ãƒ³ã—ãªã„ã“ã¨ã‚’å®£è¨€ã—ãŸãƒ©ãƒ³ã‚¿ã‚¤ãƒ ãŒå‡ºã¦ããŸã“ã¨ã§ã€ã‚ˆã‚Šãƒ–ãƒ©ã‚¦ã‚¶å¤–ã§ã®APIäº’æ›æ€§ãŒé«˜ã¾ã£ã¦ãã‚Œã‚‹ã“ã¨ã‚’æœŸå¾…ã—ã¦ã„ã¾ã™ã€‚([å‚è€ƒ](https://www.publickey1.jp/blog/22/denonodejscloudflare_workerswebjavascriptweb-interoperable_runtimes_community_groupwintercg.html))

ã¾ã ãƒ™ãƒ¼ã‚¿ç‰ˆãªã®ã§è‰²ã€…ä¸è¶³ã—ã¦ã„ã‚‹ã¨ã“ã‚ãŒå¤šã„ã§ã™ãŒã€ä»Šå¾Œã‚‚å‹•å‘ã‚’è¦‹å®ˆã£ã¦è¡ŒããŸã„ã¨æ€ã„ã¾ã™ã€‚
